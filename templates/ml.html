{% extends "base.html" %}
{% block content %}
<!-- Fondo general con degradado usando paleta Dinobrew -->
<section class="min-h-screen bg-gradient-to-br from-brand-50 via-brand-100 to-white dark:from-ink-900 dark:via-ink-800 dark:to-ink-900 py-10">

  <!-- Hero Section -->
  <div class="relative max-w-6xl mx-auto rounded-3xl overflow-hidden shadow-xl mb-14">
    <img src="{{ url_for('static', filename='img/beer_hero.jpg') }}"
         alt="Cerveza artesanal sin alcohol Fresa y Mora"
         class="w-full h-96 object-cover brightness-75">

    <!-- Indicador de página activa -->
    <div class="absolute top-4 right-4 z-20">
      <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-brand-600/90 backdrop-blur-sm text-white text-sm font-medium shadow-lg">
        <i class="fa-solid fa-chart-bar text-gold-300"></i>
        <span>DinoAnalyticsML</span>
      </div>
    </div>

    <div class="absolute inset-0 flex flex-col items-center justify-center text-center text-white px-6">
      <span class="inline-block px-4 py-1 bg-white/20 backdrop-blur-sm rounded-full text-sm font-medium mb-4 border border-white/25 animate-pulse">
        Inteligencia Artificial para tu negocio
      </span>

      <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight drop-shadow-2xl relative">
        <span class="bg-clip-text text-transparent bg-gradient-to-r from-white to-gold-200">DINOANALYTICSML</span>
        <span class="absolute inset-0 -z-10 bg-gradient-to-r from-transparent via-white/20 to-transparent blur-xl"></span>
      </h1>

      <p class="text-lg md:text-2xl mt-3 font-light bg-clip-text text-transparent bg-gradient-to-r from-white to-gold-100">
        Modelos de <span class="text-gold-300">Machine Learning</span> para análisis predictivo
      </p>

      <div class="relative my-6 py-3">
        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-24 h-0.5 bg-gradient-to-r from-transparent via-gold-400 to-transparent"></div>
        <p class="text-xl md:text-2xl font-bold text-center tracking-wider">
          <span class="inline-block px-2 py-1 mx-1 bg-clip-text text-transparent bg-gradient-to-r from-gold-300 to-gold-500">Precisión.</span>
          <span class="inline-block px-2 py-1 mx-1 text-white">Innovación.</span>
          <span class="inline-block px-2 py-1 mx-1 bg-clip-text text-transparent bg-gradient-to-r from-gold-300 to-gold-500">Resultados.</span>
        </p>
        <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-24 h-0.5 bg-gradient-to-r from-transparent via-gold-400 to-transparent"></div>
      </div>
    </div>

    <div class="absolute bottom-0 left-0 w-full h-3 bg-gradient-to-r from-brand-600 via-brand-500 to-gold-600 animate-pulse"></div>

    <div class="absolute top-0 left-0 w-full h-full pointer-events-none">
      <div class="absolute top-10 left-10 w-32 h-32 bg-gold-400/10 rounded-full filter blur-xl"></div>
      <div class="absolute bottom-10 right-10 w-40 h-40 bg-brand-400/10 rounded-full filter blur-xl"></div>
    </div>
  </div>

  <!-- Introducción -->
  <section class="py-20 md:py-28 bg-white dark:bg-ink-900">
    <div class="container mx-auto px-6">
      <div class="max-w-4xl mx-auto">
        <div class="text-center mb-16">
          <span class="inline-block px-4 py-1 rounded-full text-sm font-medium mb-4
                        bg-brand-100 text-brand-700 dark:bg-ink-800 dark:text-gold-300 border border-brand-200/70 dark:border-ink-700">
            PLATAFORMA DE MACHINE LEARNING
          </span>
          <h2 class="text-4xl md:text-5xl font-extrabold text-brand-700 dark:text-gold-400 mb-6">
            DinoAnalyticsML Herramienta de Predicción
          </h2>
        </div>

        <div class="space-y-8">
          <div class="bg-brand-50 dark:bg-ink-800 rounded-2xl p-8 shadow-soft border-l-4 border-brand-500 transform hover:scale-[1.02] transition-transform duration-300">
            <p class="text-brand-900/80 dark:text-gold-100 leading-relaxed text-lg">
              <span class="font-semibold text-brand-700 dark:text-gold-300">DinoAnalyticsML</span> predice la fecha de vencimiento de tus cervezas sin alcohol,
              optimizando calidad e inventario.
            </p>
            <ul class="mt-4 space-y-2 text-brand-800 dark:text-slate-300 text-sm leading-relaxed">
              <li class="flex gap-2"><i class="fa-solid fa-check text-gold-400 mt-1"></i><span>Modelo predictivo real (endpoint Flask).</span></li>
              <li class="flex gap-2"><i class="fa-solid fa-check text-gold-400 mt-1"></i><span>Interfaz intuitiva para ingresar datos.</span></li>
            </ul>
          </div>

          <div class="rounded-2xl p-8 shadow-soft bg-gradient-to-r from-brand-100 to-gold-100 dark:from-ink-800 dark:to-ink-700 transform hover:scale-[1.02] transition-transform duration-300">
            <p class="italic text-xl font-medium text-center text-brand-900/90 dark:text-gold-100">
              <span class="font-bold text-brand-700 dark:text-gold-300">DinoAnalyticsML</span> es tu
              <span class="text-brand-700 dark:text-gold-300">aliado estratégico</span> para asegurar frescura y consistencia.
            </p>
          </div>
        </div>

        <!-- MODELO PREDICTIVO -->
        <section class="py-20 md:py-28 bg-white dark:bg-ink-900">
          <div class="container mx-auto px-6">
            <div class="max-w-4xl mx-auto">
              <div class="text-center mb-16">
                <span class="inline-block px-4 py-1 rounded-full text-sm font-medium mb-4
                              bg-brand-100 text-brand-700 dark:bg-ink-800 dark:text-gold-300 border border-brand-200/70 dark:border-ink-700">
                  MODELO PREDICTIVO
                </span>
                <h2 class="text-4xl md:text-5xl font-extrabold text-brand-700 dark:text-gold-400 mb-6">Predicción de Fecha de Vencimiento</h2>
                <p class="text-lg text-brand-800 dark:text-slate-300 max-w-2xl mx-auto">
                  Ingresa los datos del proceso para estimar la fecha de vencimiento.
                </p>
              </div>

              <div class="glass rounded-3xl p-8 border border-white/10 shadow-soft">
                <form id="predictionForm" class="space-y-6" autocomplete="off">
                  <div class="grid md:grid-cols-2 gap-6">
                    <div>
                      <label for="productionDate" class="block text-sm font-medium text-brand-900 dark:text-white mb-2">
                        Fecha de Inicio del Proceso
                      </label>
                      <input type="date" id="productionDate" name="productionDate" required
                             class="w-full px-4 py-2 rounded-lg border border-brand-300 dark:border-ink-600 bg-white dark:bg-ink-800 text-brand-900 dark:text-white focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                    </div>

                    <div>
                      <label for="beerType" class="block text-sm font-medium text-brand-900 dark:text-white mb-2">
                        Tipo de Cerveza
                      </label>
                      <select id="beerType" name="beerType" required
                              class="w-full px-4 py-2 rounded-lg border border-brand-300 dark:border-ink-600 bg-white dark:bg-ink-800 text-brand-900 dark:text-white focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                        <option value="">Selecciona un sabor</option>
                        <option value="fresa">Fresa</option>
                        <option value="mora">Mora</option>
                      </select>
                    </div>

                    <div>
                      <label for="fermentationDays" class="block text-sm font-medium text-brand-900 dark:text-white mb-2">
                        Tiempo de Fermentación (días)
                      </label>
                      <input type="number" id="fermentationDays" name="fermentationDays" min="1" max="30" required
                             class="w-full px-4 py-2 rounded-lg border border-brand-300 dark:border-ink-600 bg-white dark:bg-ink-800 text-brand-900 dark:text-white focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                    </div>

                    <div>
                      <label for="storageDays" class="block text-sm font-medium text-brand-900 dark:text-white mb-2">
                        Tiempo de Almacenamiento (días)
                      </label>
                      <input type="number" id="storageDays" name="storageDays" min="1" max="180" required
                             class="w-full px-4 py-2 rounded-lg border border-brand-300 dark:border-ink-600 bg-white dark:bg-ink-800 text-brand-900 dark:text-white focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                    </div>

                    <div>
                      <label for="temperature" class="block text-sm font-medium text-brand-900 dark:text-white mb-2">
                        Temperatura de Almacenamiento (°C)
                      </label>
                      <input type="number" id="temperature" name="temperature" min="0" max="30" step="0.1" required
                             class="w-full px-4 py-2 rounded-lg border border-brand-300 dark:border-ink-600 bg-white dark:bg-ink-800 text-brand-900 dark:text-white focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                    </div>

                    <div>
                      <label for="packaging" class="block text-sm font-medium text-brand-900 dark:text-white mb-2">
                        Tipo de Envase
                      </label>
                      <select id="packaging" name="packaging" required
                              class="w-full px-4 py-2 rounded-lg border border-brand-300 dark:border-ink-600 bg-white dark:bg-ink-800 text-brand-900 dark:text-white focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                        <option value="">Selecciona un envase</option>
                        <option value="botella_vidrio">Botella de Vidrio</option>
                        <option value="lata">Lata de Aluminio</option>
                        <option value="barril">Barril</option>
                      </select>
                    </div>
                  </div>

                  <div class="text-center pt-4">
                    <button id="btnPredict" type="submit"
                            class="px-6 py-3 bg-gradient-to-r from-brand-600 to-gold-600 text-white font-medium rounded-lg shadow-md hover:from-brand-700 hover:to-gold-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transform hover:scale-105 transition-all duration-300 inline-flex items-center gap-2">
                      <span id="btnLabel">Predecir Fecha de Vencimiento</span>
                      <svg id="btnSpinner" class="animate-spin h-5 w-5 hidden" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4A4 4 0 008 12H4z"></path>
                      </svg>
                    </button>
                  </div>
                </form>

                <!-- Alertas -->
                <div id="alertBox" class="mt-6 hidden p-4 rounded-xl border text-sm" role="alert" aria-live="polite"></div>

                <!-- Resultado -->
                <div id="predictionResult" class="mt-8 p-6 rounded-xl bg-gradient-to-r from-brand-50 to-gold-50 dark:from-ink-800 dark:to-ink-700 border border-brand-200 dark:border-ink-600 hidden">
                  <h3 class="text-xl font-bold text-brand-800 dark:text-gold-300 mb-2">Resultado de la Predicción</h3>
                  <div class="flex items-center justify-center">
                    <div class="text-center">
                      <p class="text-lg text-brand-700 dark:text-slate-300 mb-1">Fecha de vencimiento estimada:</p>
                      <p id="expirationDate" class="text-3xl font-bold text-brand-900 dark:text-gold-200"></p>
                      <p id="shelfDays" class="text-sm mt-2 text-brand-700/80 dark:text-slate-300/80"></p>
                    </div>
                  </div>
                  <div class="mt-4 text-sm text-brand-600 dark:text-slate-400">
                    <p>Predicción generada por el modelo DinoAnalyticsML entrenado con datos sintéticos realistas.</p>
                  </div>
                </div>
              </div>

              <!-- Explicación del modelo -->
              <div class="mt-12 bg-brand-50 dark:bg-ink-800 rounded-2xl p-6 shadow-soft">
                <h3 class="text-xl font-bold text-brand-800 dark:text-gold-300 mb-3">¿Cómo funciona?</h3>
                <p class="text-brand-700 dark:text-slate-300 mb-4">
                  El endpoint entrena/recupera un modelo de regresión (Random Forest) sobre datos sintéticos basados en reglas
                  de negocio (tipo de cerveza, fermentación, temperatura y envase) y estima los días de vida útil.
                </p>
              </div>

            </div>
          </div>
        </section>

      </div>
    </div>
  </section>
</section>

<script>
(function () {
  const form = document.getElementById('predictionForm');
  const btn = document.getElementById('btnPredict');
  const spinner = document.getElementById('btnSpinner');
  const btnLabel = document.getElementById('btnLabel');
  const resultBox = document.getElementById('predictionResult');
  const expirationDateEl = document.getElementById('expirationDate');
  const shelfDaysEl = document.getElementById('shelfDays');
  const alertBox = document.getElementById('alertBox');

  function showAlert(msg, ok=false){
    alertBox.classList.remove('hidden');
    alertBox.textContent = msg;
    if(ok){
      alertBox.className = 'mt-6 p-4 rounded-xl border text-sm bg-green-50 border-green-200 text-green-800 dark:bg-green-900/30 dark:border-green-800 dark:text-green-200';
    } else {
      alertBox.className = 'mt-6 p-4 rounded-xl border text-sm bg-red-50 border-red-200 text-red-800 dark:bg-red-900/30 dark:border-red-800 dark:text-red-200';
    }
  }
  function clearAlert(){ alertBox.classList.add('hidden'); alertBox.textContent=''; }

  function setLoading(v){
    if(v){
      btn.disabled = true;
      spinner.classList.remove('hidden');
      btnLabel.textContent = 'Calculando...';
    }else{
      btn.disabled = false;
      spinner.classList.add('hidden');
      btnLabel.textContent = 'Predecir Fecha de Vencimiento';
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearAlert();

    const payload = {
      productionDate: document.getElementById('productionDate').value,
      beerType: document.getElementById('beerType').value,
      fermentationDays: document.getElementById('fermentationDays').value,
      storageDays: document.getElementById('storageDays').value,
      temperature: document.getElementById('temperature').value,
      packaging: document.getElementById('packaging').value
    };

    // Validación mínima
    if(!payload.productionDate){
      showAlert('Debes seleccionar una fecha de inicio del proceso.');
      return;
    }
    setLoading(true);

    try{
      const res = await fetch('{{ url_for("ml.api_predict") }}', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();

      if(!res.ok || !data.ok){
        const msg = (data && data.error) ? data.error : 'No se pudo obtener la predicción.';
        showAlert(msg);
        resultBox.classList.add('hidden');
      } else {
        // Mostrar resultado
        const iso = data.expiration_date_iso;
        const dt = new Date(iso + 'T00:00:00');
        const opts = { year: 'numeric', month: 'long', day: 'numeric' };
        expirationDateEl.textContent = dt.toLocaleDateString('es-CO', opts);
        shelfDaysEl.textContent = `Vida útil estimada: ${data.shelf_life_days} días`;
        resultBox.classList.remove('hidden');
        resultBox.scrollIntoView({behavior:'smooth'});
        showAlert('Predicción generada correctamente.', true);
      }
    }catch(err){
      console.error(err);
      showAlert('Error de red o del servidor.');
      resultBox.classList.add('hidden');
    }finally{
      setLoading(false);
    }
  });
})();
</script>
{% endblock %}
