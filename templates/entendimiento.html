{% extends "base.html" %}
{% block content %}
<!-- Hero Section con imagen de fondo de la cerveza -->
<section class="relative min-h-[60vh] flex items-center justify-center text-center text-white overflow-hidden">
  <!-- Imagen de fondo con degradado superpuesto -->
  <div class="absolute inset-0 z-0">
    <img src="{{ url_for('static', filename='img/beer_hero.jpg') }}" alt="Cerveza artesanal" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-gradient-to-r from-brand-900/90 via-ink-900/80 to-ink-900/70"></div>
  </div>
  
  <!-- Contenido del hero -->
  <div class="relative z-10 max-w-4xl px-6">
    <span class="inline-block px-4 py-1 bg-gradient-to-r from-brand-500 to-gold-500 text-white rounded-full text-sm font-medium mb-4 shadow-soft">
      PANEL DE ANÁLISIS DE MERCADO
    </span>
    <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight drop-shadow-2xl mb-4">DinoAnalytics</h1>
    <p class="text-xl md:text-2xl font-light mb-8">Herramienta de análisis para el propietario</p>
    
    <!-- Información del dataset -->
    <div class="glass rounded-2xl p-6 shadow-gold border border-white/40 dark:border-gold-700/30 max-w-2xl mx-auto">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="text-left">
          <p class="text-white/90 dark:text-gold-200">Dataset activo</p>
          <p class="text-lg font-semibold text-white dark:text-gold-100">{{ filename }}</p>
        </div>
        <div class="flex items-center gap-2 px-4 py-2 rounded-full bg-white/20 dark:bg-ink-800/70 border border-white/30">
          <i class="ti ti-database text-gold-400"></i>
          <span class="text-sm font-medium text-white dark:text-gold-100">{{ all_cols|length }} columnas</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Indicador de scroll -->
  <div class="absolute bottom-8 left-1/2 -translate-x-1/2 animate-bounce">
    <i class="ti ti-chevron-down text-2xl text-white/80"></i>
  </div>
</section>

<!-- Sección principal de análisis -->
<section class="min-h-screen bg-gradient-to-br from-brand-50 via-brand-100 to-white dark:from-ink-900 dark:via-ink-800 dark:to-ink-900 py-10 -mt-20 relative z-10">
  <div class="max-w-6xl mx-auto">
    <div class="grid lg:grid-cols-3 gap-8">
      <!-- Panel de controles -->
      <section class="lg:col-span-1">
        <div class="glass rounded-3xl p-6 shadow-gold border border-white/40 dark:border-gold-700/30 h-full backdrop-blur-sm">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-brand-500 to-gold-500 flex items-center justify-center shadow-lg">
              <i class="ti ti-adjustments text-white text-lg"></i>
            </div>
            <h2 class="text-xl font-bold text-brand-800 dark:text-gold-300">Controles de Análisis</h2>
          </div>

          {% if not numeric_cols and not categorical_cols %}
            <div class="text-center py-8">
              <i class="ti ti-alert-circle text-4xl text-amber-500 mb-3"></i>
              <p class="text-slate-500 dark:text-slate-400">No se detectaron columnas. Sube un CSV en Inicio.</p>
              <a href="{{ url_for('index') }}" class="inline-block mt-4 px-4 py-2 rounded-lg bg-gradient-to-r from-brand-600 to-brand-500 text-white hover:from-brand-500 hover:to-brand-400 text-sm shadow-soft">
                Volver al Inicio
              </a>
            </div>
          {% else %}
            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-brand-800 dark:text-gold-300 mb-2">
                  <i class="ti ti-chart-bar text-brand-600 dark:text-gold-500 mr-1"></i> Variable numérica
                </label>
                <select id="numSelect" class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition">
                  {% for c in numeric_cols %}
                    <option value="{{ c }}" {% if c == default_numeric %}selected{% endif %}>{{ c }}</option>
                  {% endfor %}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-brand-800 dark:text-gold-300 mb-2">
                  <i class="ti ti-grid-dots text-brand-600 dark:text-gold-500 mr-1"></i> Nivel de detalle
                </label>
                <input id="bins" type="number" value="15" min="5" max="60" class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition">
              </div>

              <div>
                <label class="block text-sm font-medium text-brand-800 dark:text-gold-300 mb-2">
                  <i class="ti ti-category text-brand-600 dark:text-gold-500 mr-1"></i> Variable categórica
                </label>
                <select id="catSelect" class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition">
                  {% for c in categorical_cols %}
                    <option value="{{ c }}" {% if c == default_categorical %}selected{% endif %}>{{ c }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="pt-4 flex flex-col gap-3">
                <button id="btnHist" class="px-5 py-3 rounded-xl bg-gradient-to-r from-brand-600 to-brand-500 text-white hover:from-brand-500 hover:to-brand-400 shadow-soft transition-all duration-300 transform hover:scale-[1.02] flex items-center justify-center gap-2">
                  <i class="ti ti-chart-histogram"></i> Generar Histograma
                </button>
                <button id="btnCounts" class="px-5 py-3 rounded-xl bg-gradient-to-r from-sky-600 to-sky-500 text-white hover:from-sky-500 hover:to-sky-400 shadow-soft transition-all duration-300 transform hover:scale-[1.02] flex items-center justify-center gap-2">
                  <i class="ti ti-chart-bar"></i> Generar Frecuencias
                </button>
              </div>
            </div>
          {% endif %}
        </div>
      </section>

      <!-- Panel de visualizaciones -->
      <section class="lg:col-span-2 space-y-8">
        <!-- Tarjeta de Histograma -->
        <div class="glass rounded-3xl p-6 shadow-soft border border-white/40 dark:border-gold-700/30 backdrop-blur-sm">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-brand-500 to-brand-400 flex items-center justify-center shadow-md">
              <i class="ti ti-chart-histogram text-white"></i>
            </div>
            <h3 class="text-lg font-bold text-brand-800 dark:text-gold-300">Distribución de Variables</h3>
          </div>
          <div class="relative h-[300px] bg-white/50 dark:bg-slate-900/30 rounded-xl p-4">
            <canvas id="histCanvas"></canvas>
          </div>
        </div>

        <!-- Tarjeta de Frecuencias -->
        <div class="glass rounded-3xl p-6 shadow-soft border border-white/40 dark:border-gold-700/30 backdrop-blur-sm">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-sky-500 to-sky-400 flex items-center justify-center shadow-md">
              <i class="ti ti-chart-bar text-white"></i>
            </div>
            <h3 class="text-lg font-bold text-brand-800 dark:text-gold-300">Frecuencia de Categorías</h3>
          </div>
          <div class="relative h-[300px] bg-white/50 dark:bg-slate-900/30 rounded-xl p-4">
            <canvas id="barCanvas"></canvas>
          </div>
        </div>

        <!-- Tarjeta de Correlación -->
        <div class="glass rounded-3xl p-6 shadow-soft border border-white/40 dark:border-gold-700/30 backdrop-blur-sm">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-gold-500 to-gold-400 flex items-center justify-center shadow-md">
              <i class="ti ti-network text-white"></i>
            </div>
            <h3 class="text-lg font-bold text-brand-800 dark:text-gold-300">Matriz de Correlación</h3>
          </div>
          <div class="overflow-hidden rounded-xl bg-white/50 dark:bg-slate-900/30 p-4">
            <img src="{{ url_for('plot_corr') }}" alt="Matriz de correlación" class="w-full h-auto" />
          </div>
        </div>
      </section>
    </div>

    <!-- Sección de Machine Learning -->
    <div class="mt-16 glass rounded-3xl p-8 shadow-gold border border-white/40 dark:border-gold-700/30 backdrop-blur-sm">
      <div class="flex items-center gap-4 mb-8">
        <div class="w-14 h-14 rounded-full bg-gradient-to-r from-brand-600 to-gold-600 flex items-center justify-center shadow-lg">
          <i class="ti ti-brain text-white text-xl"></i>
        </div>
        <h2 class="text-2xl font-bold text-brand-800 dark:text-gold-300">Modelo de Machine Learning</h2>
      </div>

      <div class="grid lg:grid-cols-3 gap-8">
        <!-- Panel de configuración del modelo -->
        <section class="lg:col-span-1">
          <div class="glass rounded-2xl p-6 shadow-soft border border-white/40 dark:border-gold-700/30 h-full backdrop-blur-sm">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-10 h-10 rounded-full bg-gradient-to-r from-brand-500 to-gold-500 flex items-center justify-center shadow-md">
                <i class="ti ti-settings text-white"></i>
              </div>
              <h3 class="text-lg font-bold text-brand-800 dark:text-gold-300">Configuración</h3>
            </div>

            <div class="space-y-5">
              <div>
                <label class="block text-sm font-medium text-brand-800 dark:text-gold-300 mb-2">
                  <i class="ti ti-bullseye text-brand-600 dark:text-gold-500 mr-1"></i> Variable objetivo (y)
                </label>
                <select id="targetSelect" class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition">
                  {% for c in all_cols %}
                    <option value="{{ c }}">{{ c }}</option>
                  {% endfor %}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-brand-800 dark:text-gold-300 mb-2">
                  <i class="ti ti-variable text-brand-600 dark:text-gold-500 mr-1"></i> Variables predictoras (X)
                </label>
                <div class="rounded-xl border p-3 max-h-40 overflow-auto border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm">
                  {% for c in all_cols %}
                    <label class="flex items-center gap-2 py-1.5 hover:bg-brand-50 dark:hover:bg-ink-800 rounded-lg px-2 cursor-pointer transition">
                      <input type="checkbox" class="feat rounded text-brand-600 focus:ring-brand-500" value="{{ c }}">
                      <span class="text-sm">{{ c }}</span>
                    </label>
                  {% endfor %}
                </div>
                <p class="text-xs mt-2 text-slate-500 dark:text-slate-400">Si no seleccionas, se usarán todas menos la objetivo.</p>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm font-medium text-brand-800 dark:text-gold-300 mb-2">
                    <i class="ti ti-category-2 text-brand-600 dark:text-gold-500 mr-1"></i> Tipo de modelo
                  </label>
                  <select id="taskSelect" class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition">
                    <option value="">Inferir automáticamente</option>
                    <option value="classification">Clasificación</option>
                    <option value="regression">Regresión</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-brand-800 dark:text-gold-300 mb-2">
                    <i class="ti ti-robot text-brand-600 dark:text-gold-500 mr-1"></i> Algoritmo
                  </label>
                  <select id="algoSelect" class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition">
                    <option value="rf">Random Forest</option>
                    <option value="logreg">Regresión Logística</option>
                    <option value="linreg">Regresión Lineal</option>
                    <option value="knn">KNN</option>
                  </select>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm font-medium text-brand-800 dark:text-gold-300 mb-2">
                    <i class="ti ti-percentage text-brand-600 dark:text-gold-500 mr-1"></i> Test size
                  </label>
                  <input id="testSize" type="number" step="0.01" value="0.2" class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition">
                </div>
                <div>
                  <label class="block text-sm font-medium text-brand-800 dark:text-gold-300 mb-2">
                    <i class="ti ti-123 text-brand-600 dark:text-gold-500 mr-1"></i> Random state
                  </label>
                  <input id="randState" type="number" value="42" class="w-full rounded-xl border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition">
                </div>
              </div>

              <button id="btnTrain" class="w-full mt-4 px-5 py-3 rounded-xl bg-gradient-to-r from-brand-600 to-brand-500 text-white hover:from-brand-500 hover:to-brand-400 shadow-soft transition-all duration-300 transform hover:scale-[1.02] flex items-center justify-center gap-2">
                <i class="ti ti-rocket"></i> Entrenar modelo
              </button>
            </div>
          </div>
        </section>

        <!-- Panel de resultados -->
        <section class="lg:col-span-2">
          <div class="glass rounded-2xl p-6 shadow-soft border border-white/40 dark:border-gold-700/30 h-full backdrop-blur-sm">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-10 h-10 rounded-full bg-gradient-to-r from-gold-600 to-gold-500 flex items-center justify-center shadow-md">
                <i class="ti ti-chart-dots text-white"></i>
              </div>
              <h3 class="text-lg font-bold text-brand-800 dark:text-gold-300">Métricas de Desempeño</h3>
            </div>

            <div class="mb-8">
              <pre id="metricsBox" class="bg-white/80 dark:bg-slate-900/60 rounded-xl p-4 overflow-auto text-sm font-mono shadow-inner">—</pre>
            </div>

            <div id="cmWrap" class="hidden mb-8">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-amber-600 to-amber-500 flex items-center justify-center shadow-md">
                  <i class="ti ti-grid-3x3 text-white"></i>
                </div>
                <h4 class="text-md font-bold text-brand-800 dark:text-gold-300">Matriz de Confusión</h4>
              </div>
              <div class="relative h-[300px] bg-white/50 dark:bg-slate-900/30 rounded-xl p-4">
                <canvas id="cmCanvas"></canvas>
              </div>
            </div>

            <div id="downloadWrap" class="hidden mb-8">
              <a id="downloadLink" class="inline-flex items-center gap-2 px-5 py-3 rounded-xl bg-gradient-to-r from-slate-800 to-slate-700 text-white hover:from-slate-700 hover:to-slate-600 shadow-soft transition-all duration-300">
                <i class="ti ti-download"></i> Descargar modelo
              </a>
            </div>

            <hr class="my-8 border-white/60 dark:border-white/10">

            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 rounded-full bg-gradient-to-r from-sky-600 to-sky-500 flex items-center justify-center shadow-md">
                <i class="ti ti-history text-white"></i>
              </div>
              <h4 class="text-md font-bold text-brand-800 dark:text-gold-300">Historial de Modelos</h4>
            </div>

            <div class="overflow-x-auto rounded-xl border border-white/60 dark:border-white/10 shadow-sm">
              <table class="min-w-full text-sm">
                <thead class="bg-white/70 dark:bg-slate-900/40">
                  <tr class="text-left text-slate-600 dark:text-slate-300">
                    <th class="py-3 px-4 font-medium">Fecha</th>
                    <th class="py-3 px-4 font-medium">Tipo</th>
                    <th class="py-3 px-4 font-medium">Algoritmo</th>
                    <th class="py-3 px-4 font-medium">Objetivo</th>
                    <th class="py-3 px-4 font-medium">Variables</th>
                    <th class="py-3 px-4 font-medium">Descargar</th>
                    <th class="py-3 px-4 font-medium">Usar</th>
                  </tr>
                </thead>
                <tbody id="runsBody" class="divide-y divide-white/60 dark:divide-white/10">
                  <!-- Se llenará dinámicamente -->
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Sección de Insights y Recomendaciones -->
  <div class="max-w-6xl mx-auto mt-16">
    <div class="rounded-3xl p-8 md:p-12 text-center shadow-gold
                bg-gradient-to-r from-brand-700 via-brand-600 to-gold-600 dark:from-ink-900 dark:via-ink-800 dark:to-ink-900">
      <h2 class="text-3xl md:text-4xl font-bold mb-4 text-white">Insights y Recomendaciones</h2>
      <p class="text-lg text-white/90 max-w-2xl mx-auto mb-10">
        Basado en el análisis de datos, aquí tienes las principales conclusiones y recomendaciones para tu negocio.
      </p>

      <div class="grid md:grid-cols-3 gap-8 mt-8">
        <div class="glass p-6 rounded-2xl shadow-soft border border-white/40 dark:border-ink-700 backdrop-blur-sm">
          <div class="text-brand-700 dark:text-gold-400 mb-4">
            <i class="ti ti-users text-3xl"></i>
          </div>
          <h3 class="text-xl font-bold text-brand-800 dark:text-gold-300 mb-2">Perfil de Cliente</h3>
          <p id="customerProfile" class="text-slate-700 dark:text-slate-300">Cargando análisis...</p>
        </div>
        
        <div class="glass p-6 rounded-2xl shadow-soft border border-white/40 dark:border-ink-700 backdrop-blur-sm">
          <div class="text-brand-700 dark:text-gold-400 mb-4">
            <i class="ti ti-beer text-3xl"></i>
          </div>
          <h3 class="text-xl font-bold text-brand-800 dark:text-gold-300 mb-2">Preferencias</h3>
          <p id="preferences" class="text-slate-700 dark:text-slate-300">Cargando análisis...</p>
        </div>
        
        <div class="glass p-6 rounded-2xl shadow-soft border border-white/40 dark:border-ink-700 backdrop-blur-sm">
          <div class="text-brand-700 dark:text-gold-400 mb-4">
            <i class="ti ti-currency-dollar text-3xl"></i>
          </div>
          <h3 class="text-xl font-bold text-brand-800 dark:text-gold-300 mb-2">Precios Óptimos</h3>
          <p id="optimalPrices" class="text-slate-700 dark:text-slate-300">Cargando análisis...</p>
        </div>
      </div>

      <div class="mt-10">
        <a href="#"
           class="inline-flex items-center gap-2 px-8 py-4 rounded-full bg-white text-brand-700 hover:bg-brand-50 transition font-bold text-lg shadow-soft transform hover:scale-105 transition-all duration-300">
          <i class="ti ti-file-report"></i> Generar informe completo
        </a>
      </div>
    </div>
  </div>
</section>

<script>
  let histChart = null;
  let barChart = null;
  let cmChart = null;

  async function fetchJSON(url, opts) {
    const r = await fetch(url, opts);
    return await r.json();
  }

  function drawChart(ctx, type, labels, values, title) {
    if (type === 'bar' && barChart) { barChart.destroy(); }
    if (type === 'hist' && histChart) { histChart.destroy(); }
    const data = { 
      labels, 
      datasets: [{ 
        label: title, 
        data: values,
        backgroundColor: 'rgba(193, 122, 51, 0.7)',
        borderColor: 'rgba(193, 122, 51, 1)',
        borderWidth: 1
      }] 
    };
    const options = {
      responsive: true, 
      maintainAspectRatio: false,
      scales: { 
        x: { 
          ticks: { autoSkip: true, maxTicksLimit: 20 },
          grid: { color: 'rgba(193, 122, 51, 0.1)' }
        },
        y: { 
          grid: { color: 'rgba(193, 122, 51, 0.1)' }
        }
      },
      plugins: { 
        legend: { 
          labels: { 
            color: getComputedStyle(document.documentElement).colorScheme==='dark'?'#e5e7eb':'#334155',
            font: { size: 14 }
          } 
        },
        title: {
          display: true,
          text: title,
          color: getComputedStyle(document.documentElement).colorScheme==='dark'?'#e5e7eb':'#334155',
          font: { size: 16, weight: 'bold' }
        }
      }
    };
    const chartType = (type === 'hist') ? 'bar' : type;
    const chart = new Chart(ctx, { type: chartType, data, options });
    if (type === 'hist') histChart = chart; 
    else if (type === 'bar') barChart = chart;
  }

  function drawConfusion(cm) {
    if (cmChart) cmChart.destroy();
    const labels = cm.map((_, i) => `Pred ${i}`);
    const datasets = cm.map((row, i) => ({
      label: `Real ${i}`,
      data: row,
      backgroundColor: 'rgba(232, 198, 106, 0.7)',
      borderColor: 'rgba(193, 122, 51, 1)',
      borderWidth: 1
    }));
    const ctx = document.getElementById('cmCanvas').getContext('2d');
    cmChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: {
          x: { 
            stacked: true, 
            grid: { color: 'rgba(232, 198, 106, 0.1)' }
          },
          y: { 
            stacked: true, 
            grid: { color: 'rgba(232, 198, 106, 0.1)' }
          }
        },
        plugins: {
          legend: {
            labels: { 
              color: getComputedStyle(document.documentElement).colorScheme==='dark'?'#e5e7eb':'#334155',
              font: { size: 14 }
            }
          }
        }
      }
    });
  }

  document.getElementById('btnHist')?.addEventListener('click', async () => {
    const col = document.getElementById('numSelect')?.value;
    const bins = document.getElementById('bins')?.value || 15;
    if (!col) return;
    const data = await fetchJSON(`/api/column-data?mode=hist&col=${encodeURIComponent(col)}&bins=${bins}`);
    if (data.error) { alert(data.error); return; }
    const ctx = document.getElementById('histCanvas').getContext('2d');
    drawChart(ctx, 'hist', data.labels, data.values, `Histograma: ${col}`);
  });

  document.getElementById('btnCounts')?.addEventListener('click', async () => {
    const col = document.getElementById('catSelect')?.value;
    if (!col) return;
    const data = await fetchJSON(`/api/column-data?mode=counts&col=${encodeURIComponent(col)}`);
    if (data.error) { alert(data.error); return; }
    const ctx = document.getElementById('barCanvas').getContext('2d');
    drawChart(ctx, 'bar', data.labels, data.values, `Frecuencia: ${col}`);
  });

  async function loadRuns() {
    const body = document.getElementById('runsBody');
    body.innerHTML = '<tr><td class="py-3 px-4 text-slate-500" colspan="7">Cargando…</td></tr>';
    const runs = await fetchJSON('/api/ml/runs');
    if (!runs || !runs.length) {
      body.innerHTML = '<tr><td class="py-3 px-4 text-slate-500" colspan="7">Sin modelos aún.</td></tr>';
      return;
    }
    let html = '';
    for (const r of runs) {
      const predictUrl = `/predict/${r.id}`;
      html += `
        <tr class="border-t border-white/60 dark:border-white/10 hover:bg-white/50 dark:hover:bg-ink-800/50">
          <td class="py-3 px-4">${r.created_at}</td>
          <td class="py-3 px-4">
            <span class="px-2 py-1 rounded-full text-xs font-medium ${
              r.task === 'classification' 
                ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300' 
                : 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'
            }">
              ${r.task}
            </span>
          </td>
          <td class="py-3 px-4">${r.algorithm}</td>
          <td class="py-3 px-4 font-medium">${r.target}</td>
          <td class="py-3 px-4 text-sm text-slate-600 dark:text-slate-400 max-w-xs truncate" title="${r.features.join(', ')}">${r.features.join(', ')}</td>
          <td class="py-3 px-4">
            <a href="${r.download}" class="px-3 py-1.5 rounded-lg bg-slate-800 text-white hover:bg-slate-700 text-xs font-medium">
              Descargar
            </a>
          </td>
          <td class="py-3 px-4">
            <a href="${predictUrl}" class="px-3 py-1.5 rounded-lg bg-brand-600 text-white hover:bg-brand-700 text-xs font-medium">
              Usar
            </a>
          </td>
        </tr>`;
    }
    body.innerHTML = html;
  }

  async function trainModel() {
    const target = document.getElementById('targetSelect').value;
    const task = document.getElementById('taskSelect').value;
    const algo = document.getElementById('algoSelect').value;
    const testSize = parseFloat(document.getElementById('testSize').value || '0.2');
    const randState = parseInt(document.getElementById('randState').value || '42', 10);
    const features = Array.from(document.querySelectorAll('.feat:checked')).map(el => el.value);

    const payload = { target, features, algorithm: algo, task, test_size: testSize, random_state: randState };
    const res = await fetchJSON('/api/ml/train', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    const box = document.getElementById('metricsBox');
    const dlWrap = document.getElementById('downloadWrap');
    const dl = document.getElementById('downloadLink');
    const cmWrap = document.getElementById('cmWrap');

    if (res.error) {
      box.textContent = 'Error: ' + res.error;
      dlWrap.classList.add('hidden');
      cmWrap.classList.add('hidden');
      return;
    }
    box.textContent = JSON.stringify(res.metrics, null, 2);
    if (res.model_download) {
      dl.href = res.model_download;
      dlWrap.classList.remove('hidden');
    } else {
      dlWrap.classList.add('hidden');
    }
    if (res.metrics && res.metrics.confusion_matrix) {
      cmWrap.classList.remove('hidden');
      drawConfusion(res.metrics.confusion_matrix);
    } else {
      cmWrap.classList.add('hidden');
    }
    loadRuns();
  }

  // Función para cargar insights y recomendaciones
  async function loadInsights() {
    try {
      const insights = await fetchJSON('/api/insights');
      
      if (insights.error) {
        document.getElementById('customerProfile').textContent = 'No hay datos suficientes para el análisis';
        document.getElementById('preferences').textContent = 'No hay datos suficientes para el análisis';
        document.getElementById('optimalPrices').textContent = 'No hay datos suficientes para el análisis';
        return;
      }
      
      // Perfil de cliente
      if (insights.customer_profile) {
        const { age_range, gender, income_level, interests } = insights.customer_profile;
        document.getElementById('customerProfile').textContent = 
          `Los clientes que más gastan son ${gender} de ${age_range} con ingresos ${income_level}, interesados en ${interests}.`;
      } else {
        document.getElementById('customerProfile').textContent = 'No se pudo determinar el perfil de cliente';
      }
      
      // Preferencias
      if (insights.preferences && insights.preferences.length > 0) {
        let prefText = '';
        insights.preferences.forEach((pref, index) => {
          if (index > 0) prefText += ', ';
          prefText += `${pref.name} (${pref.percentage}%)`;
        });
        document.getElementById('preferences').textContent = `Preferencias: ${prefText}.`;
      } else {
        document.getElementById('preferences').textContent = 'No se pudieron determinar las preferencias';
      }
      
      // Precios óptimos
      if (insights.optimal_prices && insights.optimal_prices.length > 0) {
        let priceText = '';
        insights.optimal_prices.forEach((price, index) => {
          if (index > 0) priceText += ', ';
          priceText += `${price.product}: $${price.price}`;
        });
        document.getElementById('optimalPrices').textContent = `Precios óptimos: ${priceText}.`;
      } else {
        document.getElementById('optimalPrices').textContent = 'No se pudieron determinar los precios óptimos';
      }
    } catch (error) {
      console.error('Error al cargar insights:', error);
      document.getElementById('customerProfile').textContent = 'Error al cargar el análisis';
      document.getElementById('preferences').textContent = 'Error al cargar el análisis';
      document.getElementById('optimalPrices').textContent = 'Error al cargar el análisis';
    }
  }

  document.getElementById('btnTrain')?.addEventListener('click', trainModel);

  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btnHist')?.click();
    document.getElementById('btnCounts')?.click();
    loadRuns();
    loadInsights(); // Cargar insights al iniciar
  });
</script>
{% endblock %}