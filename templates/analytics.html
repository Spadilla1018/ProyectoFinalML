{% extends "base.html" %}
{% block content %}
<section class="min-h-screen bg-gradient-to-br from-brand-50 via-brand-100 to-white dark:from-ink-900 dark:via-ink-800 dark:to-ink-900 py-10">
  <div class="max-w-6xl mx-auto px-4">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold text-brand-800 dark:text-gold-300">DinoAnalytics · Modelo de Vencimiento</h1>
      <p class="text-brand-700/80 dark:text-slate-300 mt-1">
        Entrena un modelo DEMO con datos sintéticos realistas y realiza predicciones manuales.
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Columna izquierda: Predicción manual -->
      <div class="lg:col-span-2 glass rounded-2xl p-6 border border-white/10">
        <h2 class="text-xl font-bold mb-3 text-brand-800 dark:text-gold-300">Predicción manual</h2>

        <div class="rounded-xl p-4 bg-white/70 dark:bg-ink-800/60 border border-white/20">
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm">Fecha de envasado</label>
              <input id="pk_date" type="date" class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800">
            </div>
            <div>
              <label class="block text-sm">Días de fermentación</label>
              <input id="ferment" type="number" min="1" max="30" value="14" class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800">
            </div>
            <div>
              <label class="block text-sm">Temperatura bodega (°C)</label>
              <input id="temp" type="number" step="0.1" value="6.0" class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800">
            </div>
            <div class="flex items-center gap-2 mt-6">
              <input id="pasteur" type="checkbox" class="h-4 w-4">
              <label class="text-sm">Pasteurizado</label>
            </div>
            <div>
              <label class="block text-sm">Fruta</label>
              <select id="fruit" class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800">
                <option>fresa</option><option>mora</option><option>mixta</option>
              </select>
            </div>
            <div>
              <label class="block text-sm">Envase</label>
              <select id="bottle" class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800">
                <option>vidrio_330</option><option>vidrio_500</option><option>lata_355</option>
              </select>
            </div>
            <div>
              <label class="block text-sm">pH final</label>
              <input id="ph" type="number" step="0.01" value="4.0" class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800">
            </div>
            <div>
              <label class="block text-sm">Días distribución</label>
              <input id="dist" type="number" min="0" value="3" class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800">
            </div>
            <div>
              <label class="block text-sm">OG</label>
              <input id="og" type="number" step="0.001" value="1.040" class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800">
            </div>
            <div>
              <label class="block text-sm">FG</label>
              <input id="fg" type="number" step="0.001" value="1.010" class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800">
            </div>
          </div>

          <div class="flex flex-wrap gap-3 mt-4">
            <button id="btnFill" class="px-3 py-2 rounded-lg border border-white/20 hover:bg-white/60 dark:hover:bg-ink-700">
              Usar ejemplo realista
            </button>
            <button id="btnExpiryPredict" class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700">
              Predecir vencimiento
            </button>
          </div>

          <div id="expiryResult" class="mt-3 text-sm"></div>
        </div>

        <hr class="my-6 border-white/20">
        <h3 class="text-lg font-semibold mb-2 text-brand-800 dark:text-gold-300">Importancias de variables</h3>
        <div class="h-64"><canvas id="fiChart"></canvas></div>
      </div>

      <!-- Columna derecha: Estado y Entrenamiento -->
      <div class="glass rounded-2xl p-6 border border-white/10">
        <h2 class="text-xl font-bold mb-3 text-brand-800 dark:text-gold-300">Estado del modelo</h2>
        <div id="statusBox" class="text-sm space-y-1">
          <div class="text-slate-500">Verificando...</div>
        </div>
        <div class="mt-2 text-sm" id="downloadLine"></div>

        <hr class="my-6 border-white/20">
        <h2 class="text-xl font-bold mb-3 text-brand-800 dark:text-gold-300">Entrenar/Reentrenar</h2>

        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">n_samples</label>
              <input id="tr_n_samples" type="number" min="300" max="10000" value="1200"
                     class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">n_estimators</label>
              <input id="tr_n_estimators" type="number" min="50" max="2000" value="300"
                     class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">test_size</label>
              <input id="tr_test_size" type="text" value="0.2"
                     class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800" placeholder="0.2">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">random_state</label>
              <input id="tr_random_state" type="number" value="42"
                     class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-ink-800">
            </div>
          </div>

          <button id="btnExpiryBootstrap"
                  class="w-full px-4 py-2 rounded-lg bg-ink-900 text-white dark:bg-gold-600 dark:text-ink-900">
            Entrenar ahora
          </button>

          <div id="expiryTrainMsg" class="text-sm mt-2"></div>
          <pre id="expiryMetrics" class="text-xs mt-2 hidden rounded-lg p-3 bg-white/60 dark:bg-ink-800/60 border border-white/10"></pre>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const statusBox = document.getElementById('statusBox');
  const downloadLine = document.getElementById('downloadLine');
  const expiryTrainMsg = document.getElementById('expiryTrainMsg');
  const expiryMetrics = document.getElementById('expiryMetrics');
  const btnBootstrap = document.getElementById('btnExpiryBootstrap');
  const btnPredict = document.getElementById('btnExpiryPredict');
  const btnFill = document.getElementById('btnFill');
  const ctxFI = document.getElementById('fiChart');

  let fiChart;

  function showMsg(el, txt, ok=false){
    el.textContent = txt;
    el.className = ok ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300';
  }

  function drawFI(items){
    if(!ctxFI) return;
    const labels = items.map(x=>x.name);
    const values = items.map(x=>x.importance);
    if(fiChart){ fiChart.destroy(); }
    fiChart = new Chart(ctxFI, {
      type:'bar',
      data:{ labels, datasets:[{label:'Importancia', data:values}] },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false} },
        scales:{ x:{ticks:{autoSkip:false, maxRotation:45,minRotation:0}} }
      }
    });
  }

  async function loadStatus(){
    try{
      const r = await fetch('{{ url_for("api_expiry_status") }}');
      const data = await r.json();
      if(!r.ok){ statusBox.innerHTML = '<div class="text-red-600">Error consultando estado.</div>'; return; }

      const rows = [];
      rows.push(`<div><strong>Modelo:</strong> ${data.exists ? 'Entrenado' : 'No entrenado'}</div>`);
      if(data.exists && data.trained_at){
        rows.push(`<div><strong>Entrenado en:</strong> ${data.trained_at}</div>`);
      }
      if(data.metrics){
        const m = data.metrics;
        rows.push(`<div><strong>MAE:</strong> ${m.MAE?.toFixed?.(2) ?? m.MAE}`);
        rows.push(`<strong>RMSE:</strong> ${m.RMSE?.toFixed?.(2) ?? m.RMSE}`);
        rows.push(`<strong>R²:</strong> ${(m.R2*100).toFixed(1)}%</div>`);
      }
      if(data.params){
        rows.push(`<div class="text-xs text-slate-500">n_samples=${data.params.n_samples} · n_estimators=${data.params.n_estimators} · test_size=${data.params.test_size} · seed=${data.params.random_state}</div>`);
      }
      statusBox.innerHTML = rows.map(x=>`<div>${x}</div>`).join('');

      if(data.download_url){
        downloadLine.innerHTML = `<a class="underline text-brand-700 dark:text-gold-300" href="${data.download_url}">Descargar modelo</a>`;
      } else {
        downloadLine.innerHTML = '';
      }

      if(data.feature_importance && data.feature_importance.length){
        drawFI(data.feature_importance);
      } else {
        drawFI([]);
      }
    }catch(e){
      console.error(e);
      statusBox.innerHTML = '<div class="text-red-600">No se pudo obtener el estado.</div>';
    }
  }

  // Entrenar DEMO con hiperparámetros
  btnBootstrap.addEventListener('click', async ()=>{
    const n_samples = parseInt(document.getElementById('tr_n_samples').value || '1200',10);
    const n_estimators = parseInt(document.getElementById('tr_n_estimators').value || '300',10);
    const test_size = parseFloat((document.getElementById('tr_test_size').value || '0.2').replace(',','.'));
    const random_state = parseInt(document.getElementById('tr_random_state').value || '42',10);

    showMsg(expiryTrainMsg, 'Entrenando modelo...');
    try{
      const res = await fetch('{{ url_for("api_expiry_bootstrap") }}', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ n_samples, n_estimators, test_size, random_state })
      });
      const data = await res.json();
      if(!res.ok || data.error){
        showMsg(expiryTrainMsg, data.error || 'Error entrenando.');
        expiryMetrics.classList.add('hidden');
        return;
      }
      expiryMetrics.textContent = JSON.stringify(data.metrics, null, 2);
      expiryMetrics.classList.remove('hidden');
      showMsg(expiryTrainMsg, data.note || 'Modelo entrenado.', true);

      if(data.feature_importance){ drawFI(data.feature_importance); }
      loadStatus();
    }catch(e){
      console.error(e);
      showMsg(expiryTrainMsg, 'Fallo de red/servidor.');
    }
  });

  // Predicción manual
  btnPredict.addEventListener('click', async ()=>{
    const payload = {
      packaging_date: (document.getElementById('pk_date').value || new Date().toISOString().slice(0,10)),
      fermentation_days: parseInt(document.getElementById('ferment').value || '14', 10),
      storage_temp_c: parseFloat(document.getElementById('temp').value || '6.0'),
      pasteurized: document.getElementById('pasteur').checked ? 1 : 0,
      fruit_type: document.getElementById('fruit').value,
      bottle_type: document.getElementById('bottle').value,
      ph_final: parseFloat(document.getElementById('ph').value || '4.0'),
      distribution_days: parseInt(document.getElementById('dist').value || '3', 10),
      initial_gravity: parseFloat(document.getElementById('og').value || '1.040'),
      final_gravity: parseFloat(document.getElementById('fg').value || '1.010')
    };

    const box = document.getElementById('expiryResult');
    box.textContent = 'Calculando...'; box.className = 'text-slate-600';

    try{
      const res = await fetch('{{ url_for("api_expiry_predict") }}', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!res.ok || data.error){
        box.textContent = data.error || 'No se pudo predecir.';
        box.className = 'text-red-700 dark:text-red-300';
        return;
      }
      box.innerHTML = `
        <div class="rounded-lg p-3 border border-white/10 bg-white/70 dark:bg-ink-800/60">
          <div><strong>Vida útil estimada:</strong> ${data.shelf_life_days} días</div>
          <div><strong>Fecha de vencimiento:</strong> ${data.expiry_date}</div>
          <div class="text-xs text-slate-500 mt-1">${data.note || ''}</div>
        </div>`;
      box.className = 'text-green-700 dark:text-green-300';
    }catch(e){
      console.error(e);
      box.textContent = 'Error de red/servidor.';
      box.className = 'text-red-700 dark:text-red-300';
    }
  });

  // Rellenar ejemplo
  btnFill.addEventListener('click', ()=>{
    const today = new Date().toISOString().slice(0,10);
    document.getElementById('pk_date').value = today;
    document.getElementById('ferment').value = 14;
    document.getElementById('temp').value = 6.0;
    document.getElementById('pasteur').checked = true;
    document.getElementById('fruit').value = 'fresa';
    document.getElementById('bottle').value = 'vidrio_500';
    document.getElementById('ph').value = 4.1;
    document.getElementById('dist').value = 2;
    document.getElementById('og').value = 1.042;
    document.getElementById('fg').value = 1.012;
  });

  // Carga inicial
  loadStatus();
})();
</script>
{% endblock %}
