{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl md:text-3xl font-bold mb-2">Entendimiento de Datos</h1>
<p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Dataset activo: <strong>{{ filename }}</strong></p>

<div class="grid lg:grid-cols-3 gap-6">
  <section class="rounded-2xl glass p-5 shadow-soft">
    <h2 class="font-semibold mb-3 flex items-center gap-2">
      <i class="ti ti-adjustments"></i> Controles
    </h2>
    {% if not numeric_cols and not categorical_cols %}
      <p class="text-sm text-slate-500">No se detectaron columnas. Sube un CSV en Inicio.</p>
    {% else %}
    <div class="space-y-5 text-sm">
      <div>
        <label class="block mb-1 font-medium">Columna numérica (histograma)</label>
        <select id="numSelect" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900">
          {% for c in numeric_cols %}
            <option value="{{ c }}" {% if c == default_numeric %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block mb-1 font-medium">Bins</label>
          <input id="bins" type="number" value="15" min="5" max="60" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900">
        </div>
      </div>

      <div>
        <label class="block mb-1 font-medium">Columna categórica (frecuencias)</label>
        <select id="catSelect" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900">
          {% for c in categorical_cols %}
            <option value="{{ c }}" {% if c == default_categorical %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="flex flex-wrap gap-3 pt-1">
        <button id="btnHist" class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700">
          Dibujar Histograma
        </button>
        <button id="btnCounts" class="px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700">
          Dibujar Frecuencias
        </button>
      </div>
    </div>
    {% endif %}
  </section>

  <section class="lg:col-span-2 space-y-6">
    <div class="rounded-2xl glass p-5 shadow-soft">
      <h3 class="font-semibold mb-3">Histograma</h3>
      <div class="relative h-[260px]">
        <canvas id="histCanvas"></canvas>
      </div>
    </div>

    <div class="rounded-2xl glass p-5 shadow-soft">
      <h3 class="font-semibold mb-3">Frecuencia de categorías (Top 30)</h3>
      <div class="relative h-[260px]">
        <canvas id="barCanvas"></canvas>
      </div>
    </div>

    <div class="rounded-2xl glass p-5 shadow-soft">
      <h3 class="font-semibold mb-3">Matriz de correlación</h3>
      <img src="{{ url_for('plot_corr') }}" alt="Matriz de correlación" class="rounded-xl border border-white/60 dark:border-white/10 w-full" />
    </div>
  </section>
</div>

<script>
  let histChart = null;
  let barChart = null;

  async function fetchJSON(url) {
    const r = await fetch(url);
    return await r.json();
  }

  function drawChart(ctx, type, labels, values, title) {
    if (type === 'bar' && barChart) { barChart.destroy(); }
    if (type === 'hist' && histChart) { histChart.destroy(); }

    const data = { labels, datasets: [{ label: title, data: values }] };
    const options = {
      responsive: true, maintainAspectRatio: false,
      scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 20 } } },
      plugins: { legend: { labels: { color: getComputedStyle(document.documentElement).colorScheme==='dark'?'#e5e7eb':'#334155' } } }
    };
    const chartType = (type === 'hist') ? 'bar' : type;
    const chart = new Chart(ctx, { type: chartType, data, options });
    if (type === 'hist') histChart = chart; else barChart = chart;
  }

  document.getElementById('btnHist')?.addEventListener('click', async () => {
    const col = document.getElementById('numSelect')?.value;
    const bins = document.getElementById('bins')?.value || 15;
    if (!col) return;
    const data = await fetchJSON(`/api/column-data?mode=hist&col=${encodeURIComponent(col)}&bins=${bins}`);
    if (data.error) { alert(data.error); return; }
    const ctx = document.getElementById('histCanvas').getContext('2d');
    drawChart(ctx, 'hist', data.labels, data.values, `Histograma: ${col}`);
  });

  document.getElementById('btnCounts')?.addEventListener('click', async () => {
    const col = document.getElementById('catSelect')?.value;
    if (!col) return;
    const data = await fetchJSON(`/api/column-data?mode=counts&col=${encodeURIComponent(col)}`);
    if (data.error) { alert(data.error); return; }
    const ctx = document.getElementById('barCanvas').getContext('2d');
    drawChart(ctx, 'bar', data.labels, data.values, `Frecuencia: ${col}`);
  });

  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btnHist')?.click();
    document.getElementById('btnCounts')?.click();
  });
</script>
{% endblock %}
