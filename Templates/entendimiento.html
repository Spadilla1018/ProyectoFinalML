{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl md:text-3xl font-bold mb-2">Entendimiento de Datos</h1>
<p class="text-sm text-slate-500 mb-6">Dataset activo: <strong>{{ filename }}</strong></p>

<div class="grid lg:grid-cols-3 gap-6">
  <!-- Panel de configuración -->
  <section class="glass rounded-2xl p-5 shadow">
    <h2 class="font-semibold mb-3 flex items-center gap-2">
      <i class="ti ti-adjustments"></i> Controles
    </h2>

    <div class="space-y-5 text-sm">
      <div>
        <label class="block mb-1 font-medium">Columna numérica (histograma)</label>
        <select id="numSelect" class="w-full rounded-lg border-slate-300">
          {% for c in numeric_cols %}
            <option value="{{ c }}" {% if c == default_numeric %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block mb-1 font-medium">Bins</label>
        <input id="bins" type="number" value="15" min="5" max="60" class="w-28 rounded-lg border-slate-300">
      </div>

      <div>
        <label class="block mb-1 font-medium">Columna categórica (frecuencias)</label>
        <select id="catSelect" class="w-full rounded-lg border-slate-300">
          {% for c in categorical_cols %}
            <option value="{{ c }}" {% if c == default_categorical %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="flex gap-3">
        <button id="btnHist" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">
          Dibujar Histograma
        </button>
        <button id="btnCounts" class="px-4 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700">
          Dibujar Frecuencias
        </button>
      </div>
    </div>
  </section>

  <!-- Gráficos -->
  <section class="lg:col-span-2 space-y-6">
    <div class="glass rounded-2xl p-5 shadow">
      <h3 class="font-semibold mb-3">Histograma</h3>
      <canvas id="histCanvas" height="140"></canvas>
    </div>

    <div class="glass rounded-2xl p-5 shadow">
      <h3 class="font-semibold mb-3">Frecuencia de categorías (Top 30)</h3>
      <canvas id="barCanvas" height="140"></canvas>
    </div>

    <div class="glass rounded-2xl p-5 shadow">
      <h3 class="font-semibold mb-3">Matriz de correlación</h3>
      <img src="{{ url_for('plot_corr') }}" alt="Matriz de correlación" class="rounded-xl border border-white/60 w-full" />
    </div>
  </section>
</div>

<script>
  let histChart = null;
  let barChart = null;

  async function fetchJSON(url) {
    const r = await fetch(url);
    return await r.json();
  }

  function drawChart(ctx, type, labels, values, title) {
    if (type === 'bar' && barChart) { barChart.destroy(); }
    if (type === 'hist' && histChart) { histChart.destroy(); }

    const data = { labels: labels, datasets: [{ label: title, data: values }] };
    const options = {
      responsive: true,
      maintainAspectRatio: false,
      scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 20 } } }
    };

    const chartType = (type === 'hist') ? 'bar' : type;
    const chart = new Chart(ctx, { type: chartType, data, options });

    if (type === 'hist') histChart = chart; else barChart = chart;
  }

  document.getElementById('btnHist')?.addEventListener('click', async () => {
    const col = document.getElementById('numSelect')?.value;
    const bins = document.getElementById('bins')?.value || 15;
    if (!col) return;

    const data = await fetchJSON(`/api/column-data?mode=hist&col=${encodeURIComponent(col)}&bins=${bins}`);
    if (data.error) { alert(data.error); return; }

    const ctx = document.getElementById('histCanvas').getContext('2d');
    drawChart(ctx, 'hist', data.labels, data.values, `Histograma: ${col}`);
  });

  document.getElementById('btnCounts')?.addEventListener('click', async () => {
    const col = document.getElementById('catSelect')?.value;
    if (!col) return;

    const data = await fetchJSON(`/api/column-data?mode=counts&col=${encodeURIComponent(col)}`);
    if (data.error) { alert(data.error); return; }

    const ctx = document.getElementById('barCanvas').getContext('2d');
    drawChart(ctx, 'bar', data.labels, data.values, `Frecuencia: ${col}`);
  });

  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btnHist')?.click();
    document.getElementById('btnCounts')?.click();
  });
</script>
{% endblock %}
