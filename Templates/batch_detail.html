{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl md:text-3xl font-bold mb-2">Lote {{ b.code }}</h1>
<p class="text-sm text-slate-600 dark:text-slate-300 mb-4">
  Sabor: <strong>{{ b.flavor.name }}</strong> • Inició: {{ b.start_date }} •
  Objetivo: {{ b.target_days }} días • Estado: {{ b.status.value }}
</p>

<div class="grid lg:grid-cols-3 gap-6">
  <section class="rounded-2xl glass p-5 shadow-soft">
    <h2 class="font-semibold mb-3 flex items-center gap-2"><i class="ti ti-thermometer"></i> Nueva lectura</h2>
    <form method="post" action="{{ url_for('reading_add', batch_id=b.id) }}" class="space-y-3">
      <div>
        <label class="block text-sm font-medium mb-1">Fecha &amp; hora</label>
        <input type="datetime-local" name="ts" required class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900">
      </div>
      <div class="grid grid-cols-3 gap-3">
        <div>
          <label class="block text-sm font-medium mb-1">Temp (°C)</label>
          <input type="number" step="0.1" name="temp_c" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">SG</label>
          <input type="number" step="0.001" name="sg" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900" placeholder="1.010">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">pH</label>
          <input type="number" step="0.01" name="ph" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Notas</label>
        <input name="notes" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900">
      </div>
      <button class="px-4 py-2 rounded-lg bg-brand-600 text-white hover:bg-brand-700">Agregar</button>
    </form>

    <form method="post" action="{{ url_for('readings_upload', batch_id=b.id) }}" enctype="multipart/form-data" class="mt-4 space-y-2">
      <label class="block text-sm font-medium">Importar lecturas (CSV: ts,temp_c,sg,ph)</label>
      <input type="file" name="file" accept=".csv" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900">
      <button class="px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800">Subir CSV</button>
    </form>

    <hr class="my-4 border-white/70 dark:border-white/10">
    <h2 class="font-semibold mb-3 flex items-center gap-2"><i class="ti ti-droplet"></i> Des-alcoholización</h2>
    <form method="post" action="{{ url_for('dealcoholize_add', batch_id=b.id) }}" class="space-y-3">
      <div class="grid grid-cols-3 gap-3">
        <div>
          <label class="block text-sm font-medium mb-1">Día</label>
          <input type="number" name="day" value="{{ b.day_of_fermentation() }}" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Método</label>
          <select name="method" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900">
            <option value="agent_addition">Aditivo (recom.)</option>
            <option value="vacuum_distillation">Destilación al vacío</option>
            <option value="membrane">Membrana</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Eficacia (%)</label>
          <input type="number" step="0.1" name="efficacy_estimate" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Nota</label>
        <input name="note" class="w-full rounded-lg border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900">
      </div>
      <button class="px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700">Registrar</button>
    </form>
  </section>

  <section class="lg:col-span-2 space-y-6">
    <div class="rounded-2xl glass p-5 shadow-soft">
      <h3 class="font-semibold mb-3">Fermentación — SG</h3>
      <div class="relative h-[260px]"><canvas id="sgCanvas"></canvas></div>
    </div>
    <div class="rounded-2xl glass p-5 shadow-soft">
      <h3 class="font-semibold mb-3">Temperatura (°C)</h3>
      <div class="relative h-[260px]"><canvas id="tCanvas"></canvas></div>
    </div>
    <div class="rounded-2xl glass p-5 shadow-soft">
      <h3 class="font-semibold mb-3">pH</h3>
      <div class="relative h-[260px]"><canvas id="phCanvas"></canvas></div>
    </div>
    <div class="rounded-2xl glass p-5 shadow-soft">
      <h3 class="font-semibold mb-3">ABV estimado (objetivo &lt; 0.5%)</h3>
      <div class="relative h-[260px]"><canvas id="abvCanvas"></canvas></div>
      {% if abv is not none %}
        <p class="text-sm text-slate-600 dark:text-slate-300 mt-2">ABV actual aprox.: <strong>{{ '%.2f'|format(abv) }}%</strong></p>
      {% endif %}
    </div>
  </section>
</div>

<script>
async function getSeries() {
  const res = await fetch("{{ url_for('api_batch_series', batch_id=b.id) }}");
  return await res.json();
}
function drawLine(id, labels, values, label) {
  const ctx = document.getElementById(id).getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label, data: values, tension: 0.3 }] },
    options: { responsive: true, maintainAspectRatio: false }
  });
}
(async () => {
  const s = await getSeries();
  drawLine('sgCanvas', s.labels, s.sg, 'SG');
  drawLine('tCanvas', s.labels, s.temp, 'Temp °C');
  drawLine('phCanvas', s.labels, s.ph, 'pH');
  drawLine('abvCanvas', s.labels, s.abv, 'ABV %');
})();
</script>
{% endblock %}
